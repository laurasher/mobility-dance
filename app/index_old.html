<html>
    <head>
        <title>d3 dust and magnet</title>
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
        <script src="assets/data.js"></script>
        <style media="screen">
        .d3-tip {
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 2px;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 10px;
            width: 100%;
            line-height: 1;
            color: rgba(0, 0, 0, 0.8);
            content: "\25BC";
            position: absolute;
            text-align: center;
        }

        /* Style northward tooltips differently */
        .d3-tip.n:after {
            margin: -1px 0 0 0;
            top: 100%;
            left: 0;
        }
        #play-button {
          position: absolute;
          top: 10px;
          left: 50px;
          background: #f08080;
          padding-right: 26px;
          border-radius: 3px;
          border: none;
          color: white;
          margin: 0;
          padding: 0 12px;
          width: 60px;
          cursor: pointer;
          height: 30px;
        }

        #play-button:hover {
          background-color: #696969;
        }    
        
        .ticks {
          font-size: 10px;
        }

        .track,
        .track-inset,
        .track-overlay {
          stroke-linecap: round;
        }

        .track {
          stroke: #000;
          stroke-opacity: 0.3;
          stroke-width: 10px;
        }

        .track-inset {
          stroke: #dcdcdc;
          stroke-width: 8px;
        }

        .track-overlay {
          pointer-events: stroke;
          stroke-width: 50px;
          stroke: transparent;
          cursor: crosshair;
        }

        .handle {
          fill: #fff;
          stroke: #000;
          stroke-opacity: 0.5;
          stroke-width: 1.25px;
        }

        </style>
        <script type="text/javascript" src="js/viz.js"></script>
    </head>
    <body>
        <div id="vis"></div>
            <script>
                // set the dimensions and margins of the graph
                var margin = {top: 10, right: 30, bottom: 30, left: 60},
                    width = 1000 - margin.left - margin.right,
                    height = 400 - margin.top - margin.bottom;

                // append the svg object to the body of the page
                var svg = d3.select("#vis")
                  .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                    .attr("transform",
                          "translate(" + margin.left + "," + margin.top + ")");

                //Read the data
                d3.csv("../data/Global_Mobility_Report.csv", function(data) {
                    data_filt = data.filter(x => x.country_region == 'United States')
                    data_filt = data_filt.filter(x => x.sub_region_1 != '')
                    data_filt = data_filt.filter(x => x.sub_region_2 != '')
                    data_filt = data_filt.filter(x => x.date=='2020-03-30')

                    avg_mobility_change = data_filt.map(function (x) {
                        if (x.retail_and_recreation_percent_change_from_baseline == ""){
                            x.retail_and_recreation_percent_change_from_baseline = 0
                        }
                        if (x.grocery_and_pharmacy_percent_change_from_baseline == ""){
                            x.grocery_and_pharmacy_percent_change_from_baseline = 0
                        }
                        if (x.parks_percent_change_from_baseline == ""){
                            x.parks_percent_change_from_baseline = 0
                        }
                        if (x.transit_stations_percent_change_from_baseline == ""){
                            x.transit_stations_percent_change_from_baseline = 0
                        }
                        if (x.workplaces_percent_change_from_baseline == ""){
                            x.workplaces_percent_change_from_baseline = 0
                        }
                        if (x.residential_percent_change_from_baseline == ""){
                            x.residential_percent_change_from_baseline = 0
                        }
                      return  (parseInt(x.retail_and_recreation_percent_change_from_baseline) + 
                               parseInt(x.grocery_and_pharmacy_percent_change_from_baseline) +
                               parseInt(x.parks_percent_change_from_baseline) + 
                               parseInt(x.transit_stations_percent_change_from_baseline) +
                               parseInt(x.workplaces_percent_change_from_baseline) +
                               parseInt(x.residential_percent_change_from_baseline))/6;
                    })

                  // Add X axis
                  var x = d3.scaleLinear()
                    //.domain([0, 100])
                    .domain([0, avg_mobility_change.length])
                    .range([ 0, width ]);
                  svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                  // Add Y axis
                  var y = d3.scaleLinear()
                    .domain([0, -50])
                    .range([ 0, height]);
                  svg.append("g")
                    .call(d3.axisLeft(y));

                  // Add dots
                  svg.append('g')
                    .selectAll("dot")
                    .data(avg_mobility_change)
                    .enter()
                    .append("circle")
                      .attr("cx", function (d, i) { return x(i); } )
                      .attr("cy", function (d) { return y(d); } )
                      .attr("r", 1.5)
                      .style("fill", "#69b3a2")

                })
                ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
                var formatDateIntoYear = d3.timeFormat("%Y");
                var formatDate = d3.timeFormat("%b %Y");
                var parseDate = d3.timeParse("%m/%d/%y");

                var startDate = new Date("2004-11-01"),
                    endDate = new Date("2017-04-01");

                var margin = {top:50, right:50, bottom:0, left:50},
                    width = 960 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

                var svg = d3.select("#vis")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);  

                ////////// slider //////////

                var moving = false;
                var currentValue = 0;
                var targetValue = width;

                var playButton = d3.select("#play-button");
                    
                var x = d3.scaleTime()
                    .domain([startDate, endDate])
                    .range([0, targetValue])
                    .clamp(true);

                var slider = svg.append("g")
                    .attr("class", "slider")
                    .attr("transform", "translate(" + margin.left + "," + height/5 + ")");

                slider.append("line")
                    .attr("class", "track")
                    .attr("x1", x.range()[0])
                    .attr("x2", x.range()[1])
                  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                    .attr("class", "track-inset")
                  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                    .attr("class", "track-overlay")
                    .call(d3.drag()
                        .on("start.interrupt", function() { slider.interrupt(); })
                        .on("start drag", function() {
                          currentValue = d3.event.x;
                          update(x.invert(currentValue)); 
                        })
                    );

                slider.insert("g", ".track-overlay")
                    .attr("class", "ticks")
                    .attr("transform", "translate(0," + 18 + ")")
                  .selectAll("text")
                    .data(x.ticks(10))
                    .enter()
                    .append("text")
                    .attr("x", x)
                    .attr("y", 10)
                    .attr("text-anchor", "middle")
                    .text(function(d) { return formatDateIntoYear(d); });

                var handle = slider.insert("circle", ".track-overlay")
                    .attr("class", "handle")
                    .attr("r", 9);

                var label = slider.append("text")  
                    .attr("class", "label")
                    .attr("text-anchor", "middle")
                    .text(formatDate(startDate))
                    .attr("transform", "translate(0," + (-25) + ")")

                 
                ////////// plot //////////

                var dataset;

                var plot = svg.append("g")
                    .attr("class", "plot")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                d3.csv("circles.csv", prepare, function(data) {
                  dataset = data;
                  drawPlot(dataset);
                  
                  playButton
                    .on("click", function() {
                    var button = d3.select(this);
                    if (button.text() == "Pause") {
                      moving = false;
                      clearInterval(timer);
                      // timer = 0;
                      button.text("Play");
                    } else {
                      moving = true;
                      timer = setInterval(step, 100);
                      button.text("Pause");
                    }
                    console.log("Slider moving: " + moving);
                  })
                })

                // Add X axis
                  var x = d3.scaleLinear()
                    //.domain([0, 100])
                    .domain([0, avg_mobility_change.length])
                    .range([ 0, width ]);
                  svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                  // Add Y axis
                  var y = d3.scaleLinear()
                    .domain([0, -50])
                    .range([ 0, height]);
                  svg.append("g")
                    .call(d3.axisLeft(y));

                  // Add dots
                  svg.append('g')
                    .selectAll("dot")
                    .data(avg_mobility_change)
                    .enter()
                    .append("circle")
                      .attr("cx", function (d, i) { return x(i); } )
                      .attr("cy", function (d) { return y(d); } )
                      .attr("r", 1.5)
                      .style("fill", "#69b3a2")

                d3.csv("../data/Global_Mobility_Report.csv", function(data) {
                    data_filt = data.filter(x => x.country_region == 'United States')
                    data_filt = data_filt.filter(x => x.sub_region_1 != '')
                    data_filt = data_filt.filter(x => x.sub_region_2 != '')
                    data_filt = data_filt.filter(x => x.date=='2020-03-30')

                    avg_mobility_change = data_filt.map(function (x) {
                        if (x.retail_and_recreation_percent_change_from_baseline == ""){
                            x.retail_and_recreation_percent_change_from_baseline = 0
                        }
                        if (x.grocery_and_pharmacy_percent_change_from_baseline == ""){
                            x.grocery_and_pharmacy_percent_change_from_baseline = 0
                        }
                        if (x.parks_percent_change_from_baseline == ""){
                            x.parks_percent_change_from_baseline = 0
                        }
                        if (x.transit_stations_percent_change_from_baseline == ""){
                            x.transit_stations_percent_change_from_baseline = 0
                        }
                        if (x.workplaces_percent_change_from_baseline == ""){
                            x.workplaces_percent_change_from_baseline = 0
                        }
                        if (x.residential_percent_change_from_baseline == ""){
                            x.residential_percent_change_from_baseline = 0
                        }
                      return  (parseInt(x.retail_and_recreation_percent_change_from_baseline) + 
                               parseInt(x.grocery_and_pharmacy_percent_change_from_baseline) +
                               parseInt(x.parks_percent_change_from_baseline) + 
                               parseInt(x.transit_stations_percent_change_from_baseline) +
                               parseInt(x.workplaces_percent_change_from_baseline) +
                               parseInt(x.residential_percent_change_from_baseline))/6;
                    })
                    drawPlot(avg_mobility_change);
                })

                function prepare(d) {
                  d.id = d.id;
                  d.date = parseDate(d.date);
                  return d;
                }
                  
                function step() {
                  update(x.invert(currentValue));
                  currentValue = currentValue + (targetValue/151);
                  if (currentValue > targetValue) {
                    moving = false;
                    currentValue = 0;
                    clearInterval(timer);
                    // timer = 0;
                    playButton.text("Play");
                    console.log("Slider moving: " + moving);
                  }
                }

                function drawPlot(data) {
                var dots = plot.selectAll("dot")
                    .data(data);
                  // Add dots
                  dots.enter()
                    .append("circle")
                      .attr("cx", function (d, i) { return x(i); } )
                      .attr("cy", function (d) { return y(d); } )
                      .attr("r", 1.5)
                      .style("fill", "#69b3a2")
                    .attr("r", 8)
                          .transition()
                          .duration(400)
                          .attr("r", 25)
                            .transition()
                            .attr("r", 8);
                    // if filtered dataset has less circles than already existing, remove excess
                    dots.exit()
                    .remove();

                }

                function update(h) {
                  // update position and text of label according to slider scale
                  handle.attr("cx", x(h));
                  label
                    .attr("x", x(h))
                    .text(formatDate(h));

                  // filter data set and redraw plot
                  var newData = dataset.filter(function(d) {
                    return d.date < h;
                  })
                  drawPlot(newData);
                }
    </script>
        <button id="play-button">Play</button>
    </body>
</html>


<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <style>
    body {
      font-family:"avenir next", Arial, sans-serif;
      font-size: 12px;
      color: #696969;
    }

    #play-button {
      position: absolute;
      top: 140px;
      left: 50px;
      background: black;
      padding-right: 26px;
      border-radius: 3px;
      border: none;
      color: white;
      margin: 0;
      padding: 0 12px;
      width: 60px;
      cursor: pointer;
      height: 30px;
    }

    #play-button:hover {
      background-color: #696969;
    }    
    
    .ticks {
      font-size: 10px;
    }

    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }

    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 10px;
    }

    .track-inset {
      stroke: #dcdcdc;
      stroke-width: 8px;
    }

    .track-overlay {
      pointer-events: stroke;
      stroke-width: 50px;
      stroke: transparent;
      cursor: crosshair;
    }

    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;
      stroke-width: 1.25px;
    }
  </style>
</head>

<body>
<div id="vis">
  <button id="play-button">Play</button>
</div>
<script>

var formatDateIntoYear = d3.timeFormat("%Y");
//var formatDate = d3.timeFormat("%m/%d/%y");
var formatDate = d3.timeFormat("%Y-%m-%d");

var startDate = new Date("2020-02-15"),
    endDate = new Date("2020-04-11");

var margin = {top:50, right:50, bottom:0, left:50},
    width = 1200 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var svg = d3.select("#vis")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);  

////////// slider //////////

var moving = false;
var currentValue = 0;
var targetValue = width;

var playButton = d3.select("#play-button");

//var x_slider = d3.scaleTime()
var x_slider = d3.scaleLinear()
    .domain([startDate, endDate])
    .range([0, targetValue])
    .clamp(true);

// Add X axis
var x_dots = d3.scaleLinear()
  //.domain([0, 100])
  .domain([0, 2770])
  .range([ 0, width ])
  .clamp(true);
svg.append("g")
  .attr("transform", "translate(0," + height + ")")
 //.call(d3.axisBottom(x_dots));

// Add Y axis
var y = d3.scaleLinear()
  .domain([0, -50])
  .range([ 0, height]);
svg.append("g")
  //.call(d3.axisLeft(y));

var slider = svg.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + margin.left + "," + height/5 + ")");

slider.append("line")
    .attr("class", "track")
    .attr("x1", x_slider.range()[0])
    .attr("x2", x_slider.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() {
          currentValue = d3.event.x;
          console.log('call update here ')
          update(x_slider.invert(currentValue)); 
        })
    );

slider.insert("g", ".track-overlay")
    //.attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
  .selectAll("text")
    //.data(x_slider.ticks(10))
    .enter()
    .append("text")
    .attr("x", x_slider)
    .attr("y", 10)
    .attr("text-anchor", "middle")
    .text(function(d) { return formatDate(d); });


var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

var label = slider.append("text")  
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text(formatDate(startDate))
    .attr("transform", "translate(0," + (-25) + ")")

 
////////// plot //////////

var dataset;

var plot = svg.append("g")
    .attr("class", "plot")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
  function filter_data(_date, data){
    region = "#69b3a2";
    _date = formatDate(_date).toString()
    dates = _.uniq(data.map(x=>x.date))
    date_ind = dates.indexOf(_date) + 1
    data_filt = data.filter(x => x.country_region == 'United States')
    data_filt = data_filt.filter(x => x.sub_region_1 != '')
    data_filt = data_filt.filter(x => x.sub_region_2 != '')
    data_filt = data_filt.filter(x => x.date==dates[date_ind])
    //data_filt = _.sortBy(data_filt, 'sub_region_1')
    console.log(data_filt)

    data_obj = data_filt.map( function (x) {
        if (x.retail_and_recreation_percent_change_from_baseline == ""){
            x.retail_and_recreation_percent_change_from_baseline = 0
        }
        if (x.grocery_and_pharmacy_percent_change_from_baseline == ""){
            x.grocery_and_pharmacy_percent_change_from_baseline = 0
        }
        if (x.parks_percent_change_from_baseline == ""){
            x.parks_percent_change_from_baseline = 0
        }
        if (x.transit_stations_percent_change_from_baseline == ""){
            x.transit_stations_percent_change_from_baseline = 0
        }
        if (x.workplaces_percent_change_from_baseline == ""){
            x.workplaces_percent_change_from_baseline = 0
        }
        if (x.residential_percent_change_from_baseline == ""){
            x.residential_percent_change_from_baseline = 0
        }
        avg_mobility_change = (
                 parseInt(x.retail_and_recreation_percent_change_from_baseline) + 
                 //parseInt(x.grocery_and_pharmacy_percent_change_from_baseline) +
                 //parseInt(x.parks_percent_change_from_baseline) + 
                 parseInt(x.transit_stations_percent_change_from_baseline) + 
                 parseInt(x.workplaces_percent_change_from_baseline)) / 3
                 //parseInt(x.residential_percent_change_from_baseline))/6;
        // Southeast
        if (  ['West Virginia', 'Virginia', 'Kentucky', 'Tennessee', 'North Carolina', 'South Carolina', 'Georgia', 
          'Alabama', 'Mississippi', 'Arkansas', 'Louisiana', 'Florida'].includes(x.sub_region_1) ){
          region = 'orange';
        } 
        // Northeast
        else if (  ['Maine', 'Massachusetts', 'Rhode Island', 'Connecticut', 'New Hampshire', 'Vermont', 'New York', 'Pennsylvania', 'New Jersey',
          'Delaware', 'Maryland'].includes(x.sub_region_1) ){
          region = 'red';
        }
        // West
        else if (  ['Colorado', 'Wyoming', 'Montana', 'Idaho', 'Washington', 'Oregon', 'Utah', 'Nevada', 
          'California', 'Alaska', 'Hawaii'].includes(x.sub_region_1) ){
          region = 'blue';
        } else {
          region = "#69b3a2";
        }
        return  {'change': avg_mobility_change,
                 'region': region}
      })
      data_obj = _.sortBy(data_obj, 'region')
      //console.log(data_obj)
      return data_obj
  }

d3.csv("./static/Global_Mobility_Report.csv", function(data) {
  dataset = data;

  //data_filt = filter_data(0, dataset)
  data_filt = filter_data(new Date('2020-02-18'), dataset)
  console.log('------ DRAW FOR FIRST TIME')

  var dots = plot.selectAll(".scatterdot")
    .data(dataset);

  dots.enter()
    .append("circle")
    .attr("class", "scatterdot")
    .attr("r", 1.5)
    .style("fill", function (d) { return d.region; })

  //update all circles to new positions
  dots.transition()
    .duration(500)
    .attr("cx", function (d, i) { return x_dots(i); } )
    .attr("cy", function (d) { return y(d.change); } )
    //.style("fill", "#69b3a2")
    .style("fill", function (d) { return d.region; })
    .style("opacity", 0.5)
      .transition()
      .duration(200)
      .attr("r", 3)
        .transition()
        .attr("r", 1.5);

  drawPlot(data_filt);
  
  playButton
    .on("click", function() {
    var button = d3.select(this);
    if (button.text() == "Pause") {
      moving = false;
      clearInterval(timer);
      // timer = 0;
      button.text("Play");
    } else {
      moving = true;
      timer = setInterval(step, 100);
      button.text("Pause");
    }
    console.log("Slider moving: " + moving);
  })
})
  
function step() {
  update(x_slider.invert(currentValue));
  currentValue = currentValue + (targetValue/151);
  if (currentValue > targetValue) {
    moving = false;
    currentValue = 0;
    clearInterval(timer);
    // timer = 0;
    playButton.text("Play");
    console.log("Slider moving: " + moving);
  }
}

function drawPlot(dataset) {
  var dots = plot.selectAll(".scatterdot")
    .data(dataset);

  // if filtered dataset has less circles than already existing, remove excess
  dots.exit()
    .remove();

  // if filtered dataset has more circles than already existing, transition new ones in
  dots.enter()
    .append("circle")
    .attr("class", "scatterdot")
    .attr("r", 1.5)
    .attr("cx", function (d, i) { return x_dots(i); } )
    .attr("cy", function (d) { return y(d.change); } )
    //.style("fill", "#69b3a2")
    .style("fill", function (d) { return d.region; })

  //update all circles to new positions
  dots.transition()
    .duration(500)
    .attr("cx", function (d, i) { return x_dots(i); } )
    .attr("cy", function (d) { return y(d.change); } )
    //.style("fill", "#69b3a2")
    .style("fill", function (d) { return d.region; })
  
  /*dots.exit()
    .remove();*/
}

function update(h) {
  console.log('UPDATE')
  // update position and text of label according to slider scale
  handle.attr("cx", x_slider(h));
  label
    .attr("x", x_slider(h))
    .text(formatDate(h));

  // filter data set and redraw plot
  new_data = filter_data((h), dataset)
  console.log(new_data.length)
  drawPlot(new_data);
}

</script>
</body>

<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <style>
    body {
      font-family:"avenir next", Arial, sans-serif;
      font-size: 12px;
      color: white;
      background: black;
    }

    #play-button {
      margin-left: 80px;
      margin-top: 20px;
      background: gray;
      padding-right: 26px;
      border-radius: 3px;
      border: none;
      color: white;
      margin: 0;
      padding: 0 12px;
      width: 60px;
      cursor: pointer;
      height: 30px;
    }

    .mobility-button {
      display: inline;
      float: left;
      background: gray;
      padding-right: 26px;
      border-radius: 3px;
      border: none;
      color: white;
      margin: 0;
      padding: 0 12px;
      width: 60px;
      cursor: pointer;
      height: 30px;
      width: auto;
      margin-left: 20px;
      font-size: 10px;
    }

    .on{
      background-color: #696969;
      border: solid;
      border-color: white
    }

    #play-button:hover {
      background-color: #696969;
    }  

    .gray-button:hover {
      background-color: #696969;
    }   
    
    .ticks {
      font-size: 10px;
    }

    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }

    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 10px;
    }

    .track-inset {
      stroke: lightgray;
      stroke-width: 8px;
    }

    .track-overlay {
      pointer-events: stroke;
      stroke-width: 50px;
      stroke: transparent;
      cursor: crosshair;
    }

    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;
      stroke-width: 1.25px;
    }
    #title{
      font-size: 36px;
      font-family:"avenir next", Arial, sans-serif;
      margin-left: 80px;
    }
    #stay-at-home{
      background: red;
      float: left;
      height: 300px;
      width: 250px;
      margin-left: 50px;
      /*display: inline;*/
      display: none;
    }
    #vis{
      float: left;
      display: inline;
    }
    #mobility-buttons{
      margin-left: 80px;

    }
    #play-button-container{
      margin-top: 60px;
      margin-left: 100px;
    }
  </style>
</head>

<body>
<p id="title">The Social Distancing Dance</p>
<div id="vis">
<div id="mobility-buttons">
    <button id="transit-button" class="mobility-button on">Transit</button>
    <button id="work-button" class="mobility-button on">Work</button>
    <button id="residential-button" class="mobility-button on">Residential</button>
    <button id="grocery-button" class="mobility-button on">Grocery</button>
    <button id="retail-button" class="mobility-button on">Retail</button>
    <button id="parks-button" class="mobility-button on">Parks</button>
</div>  
<div id="play-button-container">
  <button id="play-button" class="gray-button">Play</button>
</div>
</div>
<div id="stay-at-home">
</div>
<script>

$("#transit-button").click(function(){
  if ($("#transit-button").hasClass('on') && ($('.mobility-button.on').length > 1)) {
    $("#transit-button").removeClass('on') }
  else{
    $("#transit-button").addClass('on')
  }
  })
$("#work-button").click(function(){
  if ($("#work-button").hasClass('on') && ($('.mobility-button.on').length > 1)) {
    console.log('REMOVE WORK')
    $("#work-button").removeClass('on') }
  else{
    $("#work-button").addClass('on')
  }
  })
$("#residential-button").click(function(){
  if ($("#residential-button").hasClass('on') && ($('.mobility-button.on').length > 1)) {
    $("#residential-button").removeClass('on') }
  else{
    $("#residential-button").addClass('on')
  }
  })
$("#grocery-button").click(function(){
  if ($("#grocery-button").hasClass('on') && ($('.mobility-button.on').length > 1)) {
    $("#grocery-button").removeClass('on') }
  else{
    $("#grocery-button").addClass('on')
  }
  })
$("#retail-button").click(function(){
  if ($("#retail-button").hasClass('on') && ($('.mobility-button.on').length > 1)) {
    $("#retail-button").removeClass('on') }
    else{
      $("#retail-button").addClass('on')
    }
  })
$("#parks-button").click(function(){
  if ($("#parks-button").hasClass('on') && ($('.mobility-button.on').length > 1)) {
    $("#parks-button").removeClass('on') }
  else{
    $("#parks-button").addClass('on')
  }
  })

var states_with_orders = []

var formatDateIntoYear = d3.timeFormat("%Y");
//var formatDate = d3.timeFormat("%m/%d/%y");
var formatDate = d3.timeFormat("%Y-%m-%d");

var startDate = new Date("2020-02-15"),
    endDate = new Date("2020-04-11");

var margin = {top:80, right:50, bottom:0, left:100},
    width = 1000 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom;

var svg = d3.select("#vis")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);  

////////// slider //////////

var moving = false;
var currentValue = 0;
var targetValue = width;

var playButton = d3.select("#play-button");

//var x_slider = d3.scaleTime()
var x_slider = d3.scaleLinear()
    .domain([startDate, endDate])
    .range([0, targetValue])
    .clamp(true);

// Add X axis
var x_dots = d3.scaleLinear()
  //.domain([0, 100])
  .domain([0, 2770])
  .range([ 0, width ])
  .clamp(true);
svg.append("g")
  .attr("transform", "translate(0," + height + ")")
 //.call(d3.axisBottom(x_dots));

// Add Y axis
var y = d3.scaleLinear()
  .domain([0, -50])
  .range([ 0, height/3]);
svg.append("g")
  //.call(d3.axisLeft(y));

var slider = svg.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

slider.append("line")
    .attr("class", "track")
    .attr("x1", x_slider.range()[0])
    .attr("x2", x_slider.range()[1])
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() {
          currentValue = d3.event.x;
          update(x_slider.invert(currentValue)); 
        })
    );

slider.insert("g", ".track-overlay")
    //.attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
  .selectAll("text")
    //.data(x_slider.ticks(10))
    .enter()
    .append("text")
    .attr("x", x_slider)
    .attr("y", 10)
    .attr("text-anchor", "middle")
    .text(function(d) { return formatDate(d); });


var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

var label = slider.append("text")  
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text(formatDate(startDate))
    .style("fill", "white")
    .attr("transform", "translate(0," + (-25) + ")")

 
////////// plot //////////

var dataset;
var stay_at_home = []

d3.csv('./static/stay_at_home.csv', function(data) {
    for (var i = 0; i < data.length; i++) {
        //console.log(data[i].state);
        //console.log(data[i].order_date);
        console.log({ 'state': data[i].state,
                            'order_date': data[i].order_date
                          })
        stay_at_home.push({ 'state': data[i].state,
                            'order_date': data[i].order_date
                          })
    }
});

ploty = margin.top + height/4

var plot = svg.append("g")
    .attr("class", "plot")
    .attr("transform", "translate(" + margin.left + "," + ploty + ")");
  
  function filter_data(_date, data){
    region = "#69b3a2";
    _date = formatDate(_date).toString()
    dates = _.uniq(data.map(x=>x.date))
    date_ind = dates.indexOf(_date) + 1
    data_filt = data.filter(x => x.country_region == 'United States')
    data_filt = data_filt.filter(x => x.sub_region_1 != '')
    data_filt = data_filt.filter(x => x.sub_region_2 != '')
    data_filt = data_filt.filter(x => x.date==dates[date_ind])
    //data_filt = _.sortBy(data_filt, 'sub_region_1')
    //console.log(data_filt)
    //console.log(stay_at_home)

    data_obj = data_filt.map( function (x) {
        if (x.retail_and_recreation_percent_change_from_baseline == ""){
            x.retail_and_recreation_percent_change_from_baseline = 0
        }
        if (x.grocery_and_pharmacy_percent_change_from_baseline == ""){
            x.grocery_and_pharmacy_percent_change_from_baseline = 0
        }
        if (x.parks_percent_change_from_baseline == ""){
            x.parks_percent_change_from_baseline = 0
        }
        if (x.transit_stations_percent_change_from_baseline == ""){
            x.transit_stations_percent_change_from_baseline = 0
        }
        if (x.workplaces_percent_change_from_baseline == ""){
            x.workplaces_percent_change_from_baseline = 0
        }
        if (x.residential_percent_change_from_baseline == ""){
            x.residential_percent_change_from_baseline = 0
        }

        
        avg_mobility_change = []
        if ($('#transit-button').hasClass('on')) {avg_mobility_change.push(x.transit_stations_percent_change_from_baseline)}
        if ($('#work-button').hasClass('on')) {avg_mobility_change.push(x.workplaces_percent_change_from_baseline)}
        if ($('#residential-button').hasClass('on')) {avg_mobility_change.push(x.residential_percent_change_from_baseline)}
        if ($('#grocery-button').hasClass('on')) {avg_mobility_change.push(x.grocery_and_pharmacy_percent_change_from_baseline)}
        if ($('#retail-button').hasClass('on')) {avg_mobility_change.push(x.retail_and_recreation_percent_change_from_baseline)}
        if ($('#parks-button').hasClass('on')) {avg_mobility_change.push(x.parks_percent_change_from_baseline)}

        var total = 0
        avg_mobility_change.forEach(function (x) {
            total += parseInt(x)        
        });

        avg_mobility_change = total / avg_mobility_change.length
        
        //console.log("Manual with buttons ", avg_mobility_change)
        /*
        avg_mobility_change = (
                 parseInt(x.retail_and_recreation_percent_change_from_baseline) + 
                 parseInt(x.grocery_and_pharmacy_percent_change_from_baseline) +
                 parseInt(x.parks_percent_change_from_baseline) + 
                 parseInt(x.transit_stations_percent_change_from_baseline) + 
                 parseInt(x.workplaces_percent_change_from_baseline) +
                 parseInt(x.residential_percent_change_from_baseline)) / 6;
        */
        //console.log("Old way ", avg_mobility_change)

        // Northeast
        if (  ['Maine', 'Massachusetts', 'Rhode Island', 'Connecticut', 'New Hampshire', 'Vermont', 
          'New York', 'Pennsylvania', 'New Jersey', 'Delaware', 'Maryland'].includes(x.sub_region_1) ){
          //region = '#948718';
          region = '#7fa998'
          //region = 'red'
        }
        // Southeast
        else if (  ['West Virginia', 'Virginia', 'Kentucky', 'Tennessee', 'North Carolina', 'South Carolina', 'Georgia', 
          'Alabama', 'Mississippi', 'Arkansas', 'Louisiana', 'Florida'].includes(x.sub_region_1) ){
          //region = '#948C43';
          region = '#f1f1b0'
          //region = 'blue'
        } 
        // West
        else if (  ['Colorado', 'Wyoming', 'Montana', 'Idaho', 'Washington', 'Oregon', 'Utah', 'Nevada', 
          'California', 'Alaska', 'Hawaii'].includes(x.sub_region_1) ){
          region = '#948E57';
          //region = 'green'
        }
        // Midwest
        else if (  ['Ohio', 'Indiana', 'Michigan', 'Illinois', 'Missouri', 'Wisconsin', 'Minnesota', 'Iowa', 
          'Kansas', 'Nebraska', 'South Dakota', 'North Dakota'].includes(x.sub_region_1) ){
          //region = '#94906C';
          region = '#df8543'
          //region = 'purple'
        }
        // Southwest
        else if (  ['Texas', 'Oklahoma', 'New Mexico', 'Arizona'].includes(x.sub_region_1) ){
          //region = '#94927E';
          region = '#9d2503'
          //region = 'white'

        } else {
          region = "#69b3a2";
        }
        return  {'change': avg_mobility_change,
                 'region': region}
      })
      data_obj = _.sortBy(data_obj, 'region')
      //console.log(data_obj)
      return data_obj
  }

d3.csv("./static/Global_Mobility_Report.csv", function(data) {
  dataset = data;

  //data_filt = filter_data(0, dataset)
  data_filt = filter_data(new Date('2020-02-18'), dataset)
  console.log('------ DRAW FOR FIRST TIME')

  var dots = plot.selectAll(".scatterdot")
    .data(dataset);
  /*
  dots.enter()
    .append("circle")
    .attr("class", "scatterdot")
    .attr("r", 1.5)
    .style("fill", function (d) { return d.region; })*/

  //update all circles to new positions
  dots.transition()
    .duration(500)
    .attr("cx", function (d, i) { return x_dots(i); } )
    .attr("cy", function (d) { return y(d.change); } )
    //.style("fill", "#69b3a2")
    .style("fill", function (d) { return d.region; })
    .style("opacity", 0.5)
      .transition()
      .duration(200)
      .attr("r", 3)
        .transition()
        .attr("r", 1.5);

  drawPlot(data_filt);
  
  playButton
    .on("click", function() {
    var button = d3.select(this);
    if (button.text() == "Pause") {
      moving = false;
      clearInterval(timer);
      // timer = 0;
      button.text("Play");
    } else {
      moving = true;
      timer = setInterval(step, 100);
      button.text("Pause");
    }
    console.log("Slider moving: " + moving);
  })
})
  
function step() {
  update(x_slider.invert(currentValue));
  currentValue = currentValue + (targetValue/151);
  if (currentValue > targetValue) {
    moving = false;
    currentValue = 0;
    clearInterval(timer);
    // timer = 0;
    playButton.text("Play");
    console.log("Slider moving: " + moving);
  }
}

function drawPlot(dataset) {
  var dots = plot.selectAll(".scatterdot")
    .data(dataset);

  // if filtered dataset has less circles than already existing, remove excess
  dots.exit()
    .remove();

  // if filtered dataset has more circles than already existing, transition new ones in
  dots.enter()
    .append("circle")
    .attr("class", "scatterdot")
    .attr("r", 1.5)
    .attr("cx", function (d, i) { return x_dots(i); } )
    .attr("cy", function (d) { return y(d.change); } )
    //.style("fill", "#69b3a2")
    .style("fill", function (d) { return d.region; })

  //update all circles to new positions
  dots.transition()
    .duration(500)
    .attr("cx", function (d, i) { return x_dots(i); } )
    .attr("cy", function (d) { return y(d.change); } )
    //.style("fill", "#69b3a2")
    .style("fill", function (d) { return d.region; })
  
  /*dots.exit()
    .remove();*/
}

function update(h) {
  console.log('UPDATE')
  // update position and text of label according to slider scale
  handle.attr("cx", x_slider(h));
  label
    .attr("x", x_slider(h))
    .text(formatDate(h));

  d = formatDate(h).toString()

  _ind = stay_at_home.map(x=>x.order_date).indexOf(d)
  if (_ind > 0){
    stay_at_home_state = stay_at_home[_ind].state
    drawStayAtHomeDiv([stay_at_home_state])
  }

  // filter data set and redraw plot
  new_data = filter_data(h, dataset)
  drawPlot(new_data);
}

function drawStayAtHomeDiv(state){
  var txt3 = $("<p></p>").text(state);
  txt3.innerHTML = "Text.";
  $('#stay-at-home').append(txt3);  
}

</script>
</body>